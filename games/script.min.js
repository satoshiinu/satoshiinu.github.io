"use strict";let t=!1;window.onerror=(t,e,s,i,a)=>{alert(`エラーが発生しました\n再読み込みしてください\nerror: ${t}}\nat ${e},${s}:${i}`)};let e=4,s=4,i=320,a=180,n=!1,o="Proj23Fon";const r=.5;let h=1e3/60,c=Date.now()-h,l=0,u=0,d=0,m=!1,p=0,f=0,g=0,y=new Date,w=0;let x=[["img/tiles.png","tiles",!0],["img/tiles/water.png","water"],["img/items.png","items",!0],["img/players/players.png","players",!0],["img/enemy.png","enemy",!0],["img/misc/particle.png","particle",!1],["img/misc/sweep.png","sweep",!1],["img/players/item_models.png","item_model",!1],["img/gui/gui.png","gui",!0],["img/gui/prompt.png","gui_prompt",!0],["img/gui/prompt2.png","gui_prompt_more",!0],["img/gui/tab_select.png","gui_tab_select",!0],["img/gui/scroll_bar.png","gui_scroll_bar",!0],["img/gui/touch.png","touch_button",!1]],b=[["param/item.json","item",!0],["param/lang/en_us.json","en_us",!0],["param/lang/ja_jp.json","ja_jp",!0],["param/ui.json","jsonui",!0,"jsonui"],["param/levelTest.json","level",!0]],v=[["audio/select.ogg","select",!1],["audio/break.ogg","break",!1,.5],["audio/breakbit.ogg","breakbit",!1,.5],["audio/attack.ogg","attack",!1],["audio/attack2.ogg","damage",!1],["audio/attack2.ogg","death",!1],["audio/cancel.ogg","cancel",!1]];class k{constructor(t,e,s,i){this.src=t,this.name=e,this.nessesary=s,this.meta=i}}x=x.map((t=>new k(...t))),b=b.map((t=>new k(...t))),v=v.map((t=>new k(...t)));new Array;class M{constructor(t=0,e=0){this.x=t,this.y=e}toString(){return`x${this.x}_y${this.y}`}[Symbol.iterator]=function*(){yield this.x,yield this.y};classType="vec2"}class T{constructor(t=0,e=0){this.w=t,this.h=e}toString(){return`w${this.w}_h${this.h}`}[Symbol.iterator]=function*(){yield this.w,yield this.h};classType="size"}class C{constructor(t,e,s,i){this.x=t,this.y=e,this.w=s,this.h=i}toString(){return`x${this.x}_y${this.y}_w${this.w}_h${this.h}`}[Symbol.iterator]=function*(){yield this.x,yield this.y,yield this.w,yield this.h};classType="rect"}Symbol.iterator;class A{constructor(t,e,s,i){this.startX=t,this.startY=e,this.endX=s,this.endY=i}toString(){return`startX${this.startX}_startY${this.startY}_endX${this.endX}_endY${this.endY}`}[Symbol.iterator]=function*(){yield this.startX,yield this.startY,yield this.endX,yield this.endY};classType="startend"}class I extends M{getTilePos(){return new P(Math.floor(this.x/16),Math.floor(this.y/16))}}class O extends M{isChunkPos=!1;getChunkPos(){return new P(Math.floor(this.x/nt.w),Math.floor(this.y/nt.h))}getInChunkPos(){return new P(Math.abs(this.x%nt.w),Math.abs(this.y%nt.h))}getInChunkIndex(){return this.getInChunkPos(this).x+this.getInChunkPos(this).y*nt.w}classType="pos"}class P extends M{isChunkPos=!0;getChunkPos(){return this}classType="cpos"}class _{constructor(t,e,s,i){this.x0=t,this.y0=e,this.x1=s,this.y1=i}expand(t,e){let s=this.x0,i=this.y0,a=this.x1,n=this.y1;return new _(s,i,a,n)}move(t,e){this.x0+=t,this.y0+=e,this.x1+=t,this.y1+=e}clipXCollide(t,e){if(t.y1<=this.y0||t.y0>=this.y1)return e;if(e>0&&t.x1<=this.x0){let s=this.x0-t.x1;s<e&&(e=s)}if(e<0&&t.x0>=this.x1){let s=this.x1-t.x0;s>e&&(e=s)}return e}clipYCollide(t,e){if(t.x1<=this.x0||t.x0>=this.x1)return e;if(e>0&&t.y1<=this.y0){let s=this.y0-t.y1;s<e&&(e=s)}if(e<0&&t.y0>=this.y1){let s=this.y1-t.y0;s>e&&(e=s)}return e}}let S=new Array;class D{constructor(t,e,s=this.getDefaultValue(type)){if(void 0===t)throw new Error("name is undefined");if(void 0===e)throw new Error("group is undefined");this.name=t,this.group=e,this.value=s,S.push(this)}change(){if("bool"===this.type)this.value=!this.value}set(t){if("bool"===this.type)this.value=t}getDefaultValue(t){switch(t){case"bool":return!1;case"number":return 0}}}class j extends D{type="bool"}function E(t){return S.filter((e=>e.name===t))[0]}function z(t){return E(t).value}new j("AttackRotateRock","player",!0),new j("AutoAim","weapon",!0);class ${type=null;icon=null;name=null;constructor(t){void 0!==t&&(this.type=t.type,this.icon=t.icon,this.name=t.name,this.healPower=t.healPower)}static of(){return new $}setType(t){return this.type=t,this}setIcon(t){return this.icon=t,this}setName(t){return this.name=t,this}setHealPower(t){return this.healPower=t,this}}let N=new Array;class X extends ${count=10;roleSelectAble=!1;constructor(t,e){super(...arguments),this.count=e,U.push(this)}static init(){X.register("apple",Y,$.of().setIcon(0).setHealPower(20))}mayUse(t,e=0){const s=this.getIndex,i=B[e];return!this.roleSelectAble||t?!!this.use(i)&&(this.decrementStack(1),!0):(oe("item_role_select",128,64,void 0,s),2)}use(t){return!0}decrementStack(t=1){this.count-=t,0==this.count&&this.remove()}get getIndex(){return U.indexOf(this)}remove(){U.splice(this.getIndex,1)}static register(){tt(N,...arguments)}getRegisterName(){return Object.entries(Z).find((([t,e])=>e.constructor===this.constructor))?.[0]}getDisplayName(){return Ze(`item.${this.getRegisterName()}.name`)}getDisplayEfficacy(){return Ze("none")}getDisplayEfficacyIcon(){return null}}class L extends X{roleSelectAble=!0}class Y extends L{use(t){return t.heal(this.healPower)}getDisplayEfficacy(){return Ze("none")}getDisplayEfficacyIcon(){return Qt.itemHealIcon}}let U=new Array;class R{static x=0;static y=0;static offset={x:0,y:0};static tick(){this.x=F.pos.x-160+this.offset.x+gt.camx,this.y=F.pos.y-80+this.offset.y+gt.camy}}class H{static move(t,e){let s=ot.getCubes(this.bb.expand(t,e));for(let e of s)t=e.clipXCollide(this.bb,t);this.bb.move(t,0);for(let t of s)e=t.clipYCollide(this.bb,e);this.bb.move(0,e),this.pos.x=Math.round(this.bb.x0),this.pos.y=Math.round(this.bb.y0)}static setPos(t,e){this.bb=new _(t-this.size.w/2,e-this.size.h/2,t+this.size.w/2,e+this.size.h/2)}}let B=new Array;class F{static pos=new I;static size=new T(15,15);static bb=new _;static speed=new M;static mapID="";static key={up:!1,down:!1,right:!1,left:!1};static drawx=0;static drawy=0;static anim=0;static rotate=0;static facing=0;static canRotate=!0;static isMoveing=!1;static wasMoved=!1;static moveTimer=0;static movelog=new Array;static alive=!0;static{this.setPos(0,0)}static tick(){ms()&&(this.moveTick(),this.NpcTalkTick()),this.getAnimFlame(),this.mapChangeCheck()}static moveTick(){var t,e,s,i;this.key.up=Xt.up.press,this.key.down=Xt.down.press,this.key.right=Xt.right.press,this.key.left=Xt.left.press,!this.canRotate||Xt.attack.press&&z("AttackRotateRock")||(this.facing=(t=this.key.up,e=this.key.down,s=this.key.right,i=this.key.left,(!t||e||s||i?t||!e||s||i?t||e||!s||i?t||e||s||!i?t&&!e&&s&&!i?3:t&&!e&&!s&&i?1:!t&&e&&s&&!i?3:!t&&e&&!s&&i?1:t&&!e&&s&&i?2:!t&&e&&s&&i?0:t&&e&&s&&!i?3:t&&e&&!s&&i?1:null:1:3:0:2)??this.facing),this.rotate=function(t,e,s,i){return!t||e||s||i?t||!e||s||i?t||e||!s||i?t||e||s||!i?t&&!e&&s&&!i?5:t&&!e&&!s&&i?3:!t&&e&&s&&!i?7:!t&&e&&!s&&i?1:t&&!e&&s&&i?4:!t&&e&&s&&i?0:t&&e&&s&&!i?6:t&&e&&!s&&i?2:null:2:6:0:4}(this.key.up,this.key.down,this.key.right,this.key.left)??this.rotate),this.key.up||this.key.down||this.key.right||this.key.left?this.isMoveing=!0:this.isMoveing=!1,Math.abs(this.speed.x)+Math.abs(this.speed.y)>=1?this.wasMoved=!0:this.wasMoved=!1,this.wasMoved&&(this.moveTimer+=.12),this.movelog.splice(64,1/0),this.speed.x>0?this.speed.x=Math.floor(.85*this.speed.x*1e3)/1e3:this.speed.x=Math.ceil(.85*this.speed.x*1e3)/1e3,this.speed.y>0?this.speed.y=Math.floor(.85*this.speed.y*1e3)/1e3:this.speed.y=Math.ceil(.85*this.speed.y*1e3)/1e3,this.key.up&&(this.speed.y-=.5),this.key.down&&(this.speed.y+=.5),this.key.right&&(this.speed.x+=.5),this.key.left&&(this.speed.x-=.5),this.move(this.speed.x,this.speed.y,!0)}static move(t,e,s){for(let e=0;e<Math.round(Math.abs(t))&&(this.pos.x+=Math.sign(t),Ge(this.pos.x,this.pos.y)&&s&&(this.pos.x-=Math.sign(t)),!(e>ct.move_limit));e++);for(let t=0;t<Math.round(Math.abs(e))&&(this.pos.y+=Math.sign(e),Ge(this.pos.x,this.pos.y)&&s&&(this.pos.y-=Math.sign(e)),!(t>ct.move_limit));t++);}static move(t,e){H.move.call(this,t,e)}static setPos(t,e){H.setPos.call(this,t,e)}static mapChangeCheck(){for(const t in ct.map.warp){let[e,s,i,a]=[16*ct.map.warp[t].x,16*ct.map.warp[t].y,16*ct.map.warp[t].w,16*ct.map.warp[t].h];if(isNaN(i)&&(i=16),isNaN(a)&&(a=16),qe(e,s,i,a,this.pos.x,this.pos.y,16,16)){let[e,s]=[this.pos.x,this.pos.y];return null!=ct.map.warp[t].relpos?([e,s]=[16*ct.map.warp[t].relpos?.x+e,16*ct.map.warp[t].relpos.y+s],void Je(ct.map.warp[t].to,e,s)):null!=ct.map.warp[t].abspos?([e,s]=[16*ct.map.warp[t].abspos?.x,16*ct.map.warp[t].abspos.y],void Je(ct.map.warp[t].to,e,s)):void Je(ct.map.warp[t].to)}}}static NpcTalkTick(){}static getAnimFlame(){if(!this.wasMoved)return 2;switch(Math.floor(this.moveTimer%4)){case 0:return 0;case 1:case 3:return 2;case 2:return 1}}}class V{constructor(){this.reset()}reset(){this.time=0,this.pos=new M,this.start=new M,this.autoAim=new M,this.rotate=new M,this.speed=1}get getPlayer(){for(const t of B)if(t.weapon==this)return t}attack(){this.time=1,this.pos=new M,this.start=new M(this.getPlayer.getPosX,this.getPlayer.getPosY),this.autoAim=new M,this.rotate=new M(...ct.rotate_pos[F.rotate]),this.speed=1}tick(){if(this.time>0){let t=new Array;t=function(t,e,s,i,a,n="black"){let o=new Array;for(const r of G.filter((t=>!!Ve(a)||t instanceof a)))qe(r.pos.x,r.pos.y,r.size.w,r.size.h,t,e,s,i,n)&&o.push(r);return o}(this.pos.x-8,this.pos.y-8,32,32,"Enemy");for(const e of t){const t=new M(...ct.facing_pos[F.facing]),s=2.5,i=10;e.damage(i,t.x*s,t.y*s,!0)}const e="map1";let s=function(t,e,s,i,a="black",n,o){let r=Math.round(t/16),h=Math.round(e/16),c=new Array;for(let t=0;t<Math.ceil(s/16);t++)for(let e=0;e<Math.ceil(i/16);e++){es(16*(r+t),16*(h+e),16,16,a);let s=ot.getTile(new O(r+t,h+e))?.layer1??null,i={x:r+t,y:h+e,id:s};void 0===n&&c.push(i),void 0===n||Array.isArray(n)||n==s&&c.push(i),void 0!==n&&Array.isArray(n)&&n.includes(s)&&c.push(i)}return c}(this.pos.x-8,this.pos.y-8,32,32,"red",ct.breakableTile);for(const t of s)ct.breakableTileAbout[t.id].breakProbability>Math.random()&&(Be(ct.breakableTileAbout[t.id].becomeTile,e,t.x,t.y),Fe(!1,t.x,t.y),it.RockBreak.create(16*t.x+8,16*t.y+8,8),ps("break","tile")),it.RockBreak.create(16*t.x+8,16*t.y+8,.2),ps("breakbit","tile",!0);if(this.time<=12&&(0==t.length||!ct.weapon_canlock)&&S.weapon_auto_aiming){let t=this.start.x,e=this.start.y;if(function(t,e,s){let i=new Array;for(const a of ys(G,s))i.push(Xe(t,e,a.pos.x,a.pos.y));return Math.min.apply(null,i)}(t,e,J)<100){let s=function(t,e,s){let i=new Array;for(const a of ys(G,s))i.push(Xe(t,e,a.pos.x,a.pos.y));return i.indexOf(Math.min.apply(null,i))}(t,e,J),i=s.size.w,a=s.size.h;this.autoAim.x+=2*Math.sign((s.pos.x+i/2-this.pos.x+16)/32),this.autoAim.y+=2*Math.sign((s.pos.y+a/2-this.pos.y+16)/32)}}this.time>12&&(this.autoAim.x*=.25,this.autoAim.y*=.25),this.pos.x=Math.floor(this.rotate.x*(64*Math.sin(Math.PI/2*this.time/12))+this.autoAim.x+this.getPlayer.getPosX),this.pos.y=Math.floor(this.rotate.y*(64*Math.sin(Math.PI/2*this.time/12))+this.autoAim.y+this.getPlayer.getPosY),0!=t.length&&ct.weapon_canlock||(this.time+=this.speed),this.time>=24&&this.reset()}else this.time--}draw(){if(this.time<=0){let t=this.time.limit(-20,1/0);ds(0,this.getPlayer.getPosX+Math.floor(16*Ue(Math.asin(-t/10/Math.PI)))-R.x,this.getPlayer.getPosY+Ue(Math.asin(-t/10/Math.PI))*Math.floor(8*Math.sin(-this.time/50)-32)-R.y)}else{const t=1,e=8;let s=Math.floor(this.time/t%e);ds(s,this.pos.x-R.x,this.pos.y-R.y),function(t,e,s){let i={x:4*Math.sign(ct.rotate_pos[t][0])*(t%2)-8+1*Math.sign(ct.rotate_pos[t][0]),y:4*Math.sign(ct.rotate_pos[t][1])*(t%2)-8+1*Math.sign(ct.rotate_pos[t][1])};ft.drawImage(Tt.sweep,32*t,0,32,32,e+i.x,s+i.y,32,32)}(s,this.pos.x-R.x,this.pos.y-R.y)}}}B[0]=new class{constructor(t=0){this.weapon=new V,this.maxHealth=500,this.health=this.maxHealth,this.damage_cooldown=0,this.id=t,this.exp={exp:0,lv:0},this.alive=!0}tick(){this.weaponTick(),this.deathCheck(),this.damage_cooldown--}weaponTick(){ms()&&(Xt.attack.down&&this.weapon.time>0&&this.weapon.speed++,Xt.attack.press&&(this.weapon.time<=0||this.weapon.time>=20)&&this.weapon.attack()),this.weapon.tick()}deathCheck(){this.health<=0&&(this.alive=!1)}damage(t,e=0,s=0){if(this.damage_cooldown>0)return!1;void 0!==e&&void 0!==s&&this.knockback(e,s),this.health-=t,this.damage_cooldown=5}heal(t){return this.health!==this.maxHealth&&(this.health+=Math.min(t,this.maxHealth),!0)}get getIndex(){return B.indexOf(this)}get getPosX(){return Ke(this.getIndex)}get getPosY(){return Qe(this.getIndex)}draw(){ft.drawImage(Tt.players,16*F.getAnimFlame(),32*F.facing,16,24,hs(this.getPosX),cs(this.getPosY)-8,16,24)}knockback(t,e){F.speed.x+=t,F.speed.y+=e}}(0),We();let G=new Array;class q{type=null;constructor(t){void 0!==t&&(this.type=t.type)}static of(){return new q}setType(t){return this.type=t,this}}class W extends q{pos=new M;speed=new M;spawn=new M;wasMoved=!1;moveSpeed=.25;size=new T(16,16);maxHealth=20;health=20;constructor(t,e,s){super(...arguments),this.spawn.x=e,this.pos.x=e,this.spawn.y=s,this.pos.y=s,this.setPos(e,s),G.push(this)}static init(){W.register("slimeBlue",Q,q.of().setType(Q.typeBlue))}tick(){this.moveBase()}moveBase(){this.speed.x>0?this.speed.x=Math.floor(.85*this.speed.x*1e3)/1e3:this.speed.x=Math.ceil(.85*this.speed.x*1e3)/1e3,this.speed.y>0?this.speed.y=Math.floor(.85*this.speed.y*1e3)/1e3:this.speed.y=Math.ceil(.85*this.speed.y*1e3)/1e3,this.speedCalc(),this.move(this.speed.x,this.speed.y)}move(t,e){H.move.call(this,t,e)}setPos(t,e){H.setPos.call(this,t,e)}speedCalc(){}draw(){ls(Tt.enemy,0,0,16,16,this.pos.x-R.x,this.pos.y-R.y)}drawCondition(){return ct.onScreenArea(new C(this.pos.x,this.pos.y,this.size.w,this.size.h))}damage(t,e=0,s=0,i=!1){return!1}despawn(){const t=G.indexOf(this);G.splice(t,1)}get getCenterX(){return this.pos.x+this.size.w/2}get getCenterY(){return this.pos.y+this.size.h/2}static register(){tt(Z,...arguments)}getRegisterName(){return Object.entries(Z).find((([t,e])=>e.constructor===this.constructor))?.[0]}dataConvert(){let t=new Object;return Object.assign(t,this),t.registerName=this.getRegisterName(),t}dataRestore(t){Object.assign(this,structuredClone(t))}static dataRestore(t){Z[t.registerName](0,0).dataRestore()}}class J extends W{damageEffect={Damage:0,ViewTime:0,HealthTime:0};#t=0;attack={coolDown:0,animTime:0,animFlag:0};get attackCondition(){return!0}attackPower=10;tick(){super.tick(...arguments),this.attackTick(),this.#t--,this.damageEffect.ViewTime--,this.damageEffect.HealthTime--,this.damageEffect.ViewTime<=0&&(this.damageEffect.Damage=0),this.health<=0&&(at.create(this.pos.x,this.pos.y,5),this.despawn())}attackTick(){if(this.attack.coolDown--,this.attackCondition)return;qe(this.pos.x,this.pos.y,this.size.w,this.size.h,Ke(0),Qe(0),16,16)&&(this.attack.coolDown<=0&&(this.attack.coolDown=50,this.attack.animFlag=!0),10==this.attack.animTime&&B[0].damage(this.attackPower,-Math.sign(this.getCenterX-(Ke(0)+8)),-Math.sign(this.getCenterY-(Qe(0)+8))))}damage(t,e=0,s=0,i=!1){super.damage(...arguments);return!(this.#t>0)&&(ps("damage","enemy",!0),this.speed.x+=e/1,this.speed.y+=s/1,this.health-=t,this.#t=5,this.damageEffect.Damage+=t,this.damageEffect.ViewTime=100,this.damageEffect.HealthTime=250,it.BlueSlime.create(this.pos.x,this.pos.y,1),!0)}drawDamageEffect(){var t,e,s;this.damageEffect.HealthTime>0&&(t=this.health/this.maxHealth,e=this.getCenterX-R.x-5,s=this.pos.y-R.y,ft.drawImage(Tt.gui,0,0,11,3,e-1,s-1,11,3),ft.drawImage(Tt.gui,0,Math.floor(9*t+3),9,1,e,s,9,1)),this.damageEffect.ViewTime>0&&ns(this.damageEffect.Damage.toString(),this.pos.x-R.x,this.pos.y-16-8*Math.log10(-8*(this.damageEffect.ViewTime/100-1))-R.y,{})}constructor(){super(...arguments)}}class K extends J{hostilityDelay=0;get hostility(){return this.hostilityDelay>0}#e={xp:!1,xn:!1,yp:!1,yn:!1,movingTime:0,get Moving(){return this.movingTime>0}};get attackCondition(){return!this.hostility}tick(){super.tick(...arguments);this.hostility&&Xe(Ke(0),Qe(0),this.pos.x,this.pos.y)>256&&this.hostilityDelay--}speedCalc(){if(this.hostility){if(Xe(this.pos.x,this.pos.y,Ke(0),Qe(0))<16)return void(this.wasMoved=!1);let s=(t=Ke(0)+ct.facing_pos[F.facing][0]-this.pos.x,e=Qe(0)+ct.facing_pos[F.facing][1]-this.pos.y,180*Math.atan2(e,t)/Math.PI);return this.speed.x+=this.moveSpeed*Math.cos(s),this.speed.y+=this.moveSpeed*Math.sin(s),void(this.wasMoved=!0)}var t,e;this.#e.yn&&(this.speed.y-=this.moveSpeed),this.#e.yp&&(this.speed.y+=this.moveSpeed),this.#e.xp&&(this.speed.x+=this.moveSpeed),this.#e.xn&&(this.speed.x-=this.moveSpeed),this.#e.movingTime>0&&(this.#e.movingTime-=1),this.#e.movingTime<=0&&(this.#e.yn=!1,this.#e.yp=!1,this.#e.xp=!1,this.#e.xn=!1,Math.random()>.95&&(Math.random()>.9&&(this.#e.yn=!0),Math.random()>.9&&(this.#e.yp=!0),Math.random()>.9&&(this.#e.xp=!0),Math.random()>.9&&(this.#e.xn=!0),(this.#e.yn||this.#e.yp||this.#e.xn||this.#e.yp)&&(this.#e.movingTime=Math.floor(5*Math.random()+5)))),this.#e.movingTime>0?this.wasMoved=!0:this.wasMoved=!1}damage(t,e=0,s=0,i=!1){super.damage(...arguments);this.hostilityDelay=100}constructor(){super(...arguments)}}class Q extends K{anim={time:0,flag:!1};size=new T(16,16);maxHealth=200;health=200;tick(){this.animationTick(),super.tick()}draw(){let t=new M(0,0);const e=this.getAnimationFlame();ls(Tt.enemy,t.x+e.x,t.y+e.y,16,16,this.pos.x-R.x,this.pos.y-R.y-5*Ye(this.attack.animTime/20)),this.drawDamageEffect()}constructor(){super(...arguments)}animationTick(){this.wasMoved&&(this.anim.flag=!0),this.anim.flag&&this.anim.time++,this.anim.time>=20&&(this.anim.time=0,this.anim.flag=!1),8==this.anim.time&&it.BlueSlime.create(this.getCenterX,this.getCenterY,1,2),this.attack.animFlag&&this.attack.animTime++,this.attack.animTime>=20&&(this.attack.animTime=0,this.attack.animFlag=!1)}getAnimationFlame(){let t=0;return this.anim.time>0&&(t=Math.floor(this.anim.time/20*3)),this.attack.animTime>0&&(t=Math.floor(this.attack.animTime/20*3)),new M(16*t,0)}static typeBlue=Symbol("Blue")}const Z={};function tt(t,e,s,i){t[e]=(...t)=>new s(i,...t),t[e].constructor=s}let et=new Array;class st{pos=new M;size=new T;time=0;lifetime=0;random=new Array;constructor(t,e,s){this.pos=new M(t,e),this.random=[Ce(-1,1),Ce(-1,1)]}static create(t=0,e=0,s=1){if(!(s<1&&Math.random()>s)){for(let t=0;t<s;t++)et.push(new this(...arguments));return s}}draw(){}drawCondition(){return ct.onScreenArea(new C(this.pos.x,this.pos.y,this.size.w,this.size.h))}tick(){this.time++,this.lifetime<=this.time&&this.despawn()}despawn(){const t=et.indexOf(this);et.splice(t,1)}}class it extends st{size=new T(8,8);DrawOffset=new M(0,0);lifetime=Ce(25,50,!0);draw(){ls(Tt.particle,this.DrawOffset.x,this.DrawOffset.y,16,16,hs(this.pos.x+16*this.random[0]*Re(this.time/this.lifetime)),cs(this.pos.y-4*Ye(this.time/this.lifetime*2)))}static RockBreak=class extends it{DrawOffset=new M(16,16)};static BlueSlime=class extends it{DrawOffset=new M(0,16)}}class at extends st{size=new T(16,16);DrawOffset=new M(0,0);lifetime=Ce(50,100,!0);draw(){ls(Tt.particle,this.DrawOffset.x+16*Math.floor(this.time/this.lifetime*8),this.DrawOffset.y,16,16,hs(this.pos.x+this.random[0]*this.time/10),cs(this.pos.y+-Math.abs(this.time*this.random[1]/10),(this.time,this.random[1])))}}const nt=new T(256,256);const ot=new class{rawData=null;chunks=new Object;levelName="test";async chunkLoad(t){return this.chunks[t.getChunkPos().toString()]=rt.create(ot,t,this.levelName),this.chunks[t.getChunkPos().toString()]=await rt.load(ot,t,this.levelName)}async chunkCreate(t){return this.chunks[t.getChunkPos().toString()]=rt.create(ot,t,this.levelName)}toString(){}getTile(t){if(t.isChunkPos)throw new Error("is cpos");return this.getChunk(t)?.getTile(t)??new ht}setTile(t,e){return Object.assign(this.getTile(t),e)}getChunk(t){return this.chunks[t.getChunkPos().toString()]??null}hasChunk(t){let e=Array.toArray(t);e.forEach((t=>t.getChunkPos()));for(const t of e)if(Object.keys(this.chunks).includes(t.toString()))return!0;return!1}autoLoadDispose(t){const e=new O(t.x/16,t.y/16).getChunkPos(),s=[new P(e.x+1,e.y+1),new P(e.x+0,e.y+1),new P(e.x-1,e.y+1),new P(e.x+1,e.y+0),new P(e.x+0,e.y+0),new P(e.x-1,e.y+0),new P(e.x+1,e.y-1),new P(e.x+0,e.y-1),new P(e.x-1,e.y-1)];for(const t of s)this.hasChunk(t)||this.chunkLoad(t);for(const t of Object.keys(this.chunks))s.map((t=>t.toString())).includes(t)||delete this.chunks[t]}getCubes(t){let e=new Array,s=Math.floor(t.x0/16-1),i=Math.ceil(t.x1/16+1),a=Math.floor(t.y0/16-1),n=Math.ceil(t.y1/16+1);for(let t=s;t<i;t++)for(let s=a;s<n;s++)this.getTile(new O(Math.floor(t),Math.floor(s))).hitbox&&e.push(new _(16*Math.floor(t),16*Math.floor(s),16*Math.floor(t)+16,16*Math.floor(s)+16));return e}};class rt{constructor(t,e=console.error("no cpos")){null===t&&(t=rt.getDefaultValue()),this.cData=t.cData.map((t=>new ht(...t))),this.cpos=e}init(t){this.cpos=t}dispose(t){}static create(t,e){return new rt(this.getDefaultValue(),e)}static async load(t,e,s){return new rt(await Pe(`/maps/${s}/${e.toString()}.json`)??null,e)}static getDefaultValue(){const t=new Object;return t.cData=new Array(nt.w*nt.h).fill(Array.from(new ht(0,0,0,0))),t}toString(){const t=Object.assign({},this);return t.cData=t.cData.map((t=>Array.from(t))),JSON.stringify(t)}getTile(t){return this.cData[t.getInChunkIndex()]}}class ht{constructor(t=0,e=0,s=0,i=0){this.layer1=t,this.layer2=e,this.hitbox=s,this.enemy=i}[Symbol.iterator]=function*(){yield this.layer1,yield this.layer2,yield this.hitbox,yield this.enemy}}class ct{static ver="24m03w5";static sessionTime=0;static isRelease=!1;static saveloadingnow=!1;static saveloadfaliedtime=-1;static saveloadfaliedtype=-1;static saveloadsuccesstime=-111;static saveloadsuccesstype=-111;static PopUpDelay=100;static PlayingScreen=!1;static move_limit=32767;static weapon_canlock=!1;static PI=Math.floor(Math.PI*Math.pow(10,5))/Math.pow(10,5);static colorPallet={magenta:"magenta",green:"lime",blue:"blue",black:"black",gray:"gray",white:"white"};static map=new Object;static map_path={VillageAround:"param/maps/VillageAroundMap.map",LvSpot:"param/maps/LvSpotMap.map",Default:"param/maps/Map.map"};static rotate_pos=[[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1],[1,0],[1,1]];static facing_pos=[[0,1],[-1,0],[0,-1],[1,0]];static tab_offset=[64,128,128,128];static gui_item_count=[15,7,15,7];static breakableTile=[9,10,11];static breakableTileAbout={9:{breakProbability:.1,becomeTile:12},10:{breakProbability:.05,becomeTile:12},11:{breakProbability:.05,becomeTile:13}};static animationTile={7:{}};static DontDrawTile=[0];static enemy_type=["slime","gorilla","fish","desert","snow","poison","fire","dark","other"];static gui_system_items=["menu.system.config","menu.system.data","menu.system.about"];static gui_system_data_items=["menu.system.data.select","menu.system.data.save","menu.system.data.load"];static config_name=["player","weapon","data","control","sounds","other","debug"];static config_icons=["player","weapon","colorFloppy","gamepad","sound","other","debug"];static soundGroupsConfig={player:"sound_player",tile:"sound_tile",enemy:"sound_enemy",gui:"sound_gui",bgm:"bgm",other:"other"};static select_y_size=[16,16,16,16];static savemetadata={codename:"project2023",ver:ct.ver};static title_items=["newgame","loadgame"];static UIListScrollable=["items","roles","hud_hp","UIOpen","config"];static getTileID(t="map1",e,s){if(void 0!==ct.map[t]&&s>=0&&s<ct.map[t].length&&e>=0&&e<ct.map[t][s].length)return ct.map[t][s][e]}static async NewGame(){if(ct.PlayingScreen)return!1;await Je("Default"),ct.StartGame()}static async LoadGame(){if(ct.PlayingScreen)return!1;await je(),ct.StartGame()}static async StartGame(){if(ct.PlayingScreen)return!1;(new fe).openUi(),ct.PlayingScreen=!0}static onScreenArea(t){let e=R.x,s=R.y,n=i,o=a,r=t.x,h=t.y,c=t.w,l=t.h,u=e+n/2,d=s+o/2,m=r+c/2,p=h+l/2,f=Math.abs(u-m),g=Math.abs(d-p);return f<(n+c)/2&&g<(o+l)/2}static characterCheck=!1}class lt{constructor(){this.visible=!1,this.text="",this.index=0,this.cool_down=0}view(t){this.visible=!0,this.text=t,this.index=0,this.cool_down=5}next(){"object"==typeof this.text&&(this.index++,this.cool_down=5,this.index<this.text.length)||gui_close("message")}}class ut{constructor(){this.visible=!1,this.selected=!1,this.func_ok=()=>{},this.func_cancel=()=>{},this.text="",this.title="",this.pos={x:0,y:0}}view(t="text",e="title",s=0,i=0,a=(()=>{}),n=(()=>{})){this.visible=!0,this.text=t,this.title=e,this.pos.x=s,this.pos.y=i,this.func_ok=a,this.func_cancel=n}}new class{constructor(){this.confirm=new ut,this.message=new lt}};class dt{constructor(t){this.sound=t,this.play=function(t=!1){t||(this.sound.currentTime=0),this.sound.play()},this.stop=function(){this.sound.currentTime=0,this.sound.pause()}}static async createAudioElem(t,e=1){return new Promise(((s,i)=>{const a=new Audio;a.preload="auto",a.volume=e,a.src=t,a.onerror=()=>{i(a.error)},a.addEventListener("canplaythrough",(()=>{s(a)}),{once:!0}),a.load()}))}static async init(t,e=1){return new dt(await dt.createAudioElem(t,Math.min(1,e)))}}let mt=!0;const pt=document.getElementById("canvas"),ft=pt.getContext("2d");pt.width=i*e,pt.height=a*s,ft.scale(e,s),ft.mozImageSmoothingEnabled=!1,ft.webkitImageSmoothingEnabled=!1,ft.msImageSmoothingEnabled=!1,ft.imageSmoothingEnabled=!1,document.oncontextmenu=()=>!1,ft.font="20px sans-serif";let gt=new Object;gt.hitboxes=new Array,gt.hitbox_visible=!0,gt.visible=!1,gt.about_visible=!1,gt.info=new Array,gt.camx=0,gt.camy=0,gt.pause_frame=new Array,gt.jsonLoadTime=new Object;let yt,wt,xt,bt,vt,kt,Mt=new Object,Tt=new Object,Ct=new Object,At={jsoncount:0,imgcount:0,soundcount:0,type:"",ejectLog:!1,fastLoad:!0},It="save.json",Ot={suggestedName:"save.json",types:[{description:"savedata",accept:{"application/json":[".json"]}}]},Pt=0,_t=0;vt=(new Date).getTime();let St=0,Dt=0,jt=0;class Et{press=!1;wasPress=!1;down=!1;hold=!1;time=-1;now=-1;change(t){this.wasPress=this.press,this.press=t}tick(){const[t,e]=[30,2];this.press?this.time++:this.time=-1,this.down=0==this.time,this.hold=0==this.time||this.time>t&&this.time%e==0,this.wasPress=this.press}hasChanged(){return this.press!==this.wasPress}}let zt=Array.from(new Array(255)).map((()=>new Et));class $t{constructor(t,e,s){this.keyCodes=t,this.touchBtns=e,this.gamepadBtns=s}tick(){this.press=!1,this.down=!1,this.hold=!1;for(const t of this.keyCodes){const e=zt[t];e.press&&(this.press||=!0),e.down&&(this.down||=!0),e.hold&&(this.hold||=!0)}}press=!1;down=!1;hold=!1}class Nt{static register(t,e,s,i){Xt[t]=new $t(e,s,i)}}let Xt=new Object;Nt.register("up",[38,87]),Nt.register("down",[40,83]),Nt.register("left",[37,65]),Nt.register("right",[39,68]),Nt.register("attack",[32]),Nt.register("confirm",[90]),Nt.register("cancel",[88]),Nt.register("menu",[67]);let Lt=[37,38,39,40,32],Yt=new Object;addEventListener("keyup",(function(t){zt[t.keyCode].change(!1),gt.visible&&80==t.keyCode&&(m=!1,requestAnimationFrame(xe))})),addEventListener("keydown",(function(t){qt=!1,zt[t.keyCode].change(!0),Lt.includes(t.keyCode)&&t.preventDefault();gt.visible&&80==t.keyCode&&cancelAnimationFrame(u);gt.visible&&79==t.keyCode&&(m=!0,requestAnimationFrame(xe))})),window.addEventListener("gamepadconnected",(function(t){t.gamepad;console.log(t)})),window.addEventListener("gamepaddisconnected",(function(t){t.gamepad;console.log(t)})),pt.addEventListener("touchstart",(function(t){ve(t)})),pt.addEventListener("touchend",(function(t){ve(t)})),pt.addEventListener("touchmove",(function(t){t.preventDefault(),ve(t)})),pt.addEventListener("touchcancel",(function(t){ve(t)}));const Ut=new Array,Rt=new Array,Ht=new Array,Bt=new Array,Ft=new Array,Vt=new Array;let Gt=[{x:64,y:112,type:"up",width:16,height:16},{x:64,y:144,type:"down",width:16,height:16},{x:80,y:128,type:"right",width:16,height:16},{x:48,y:128,type:"left",width:16,height:16},{x:144,y:128,type:"confirm",width:16,height:16},{x:160,y:128,type:"cancel",width:16,height:16},{x:176,y:128,type:"menu",width:16,height:16},{x:240,y:128,type:"attack",width:32,height:16}];let qt=!1;Tt.font=new Object;Tt.empty,Tt.tile,Tt.tile2,new Object;let Wt=new Object;Wt.atlas=[[0,0,32,32],[32,0,32,32],[64,0,32,32],[96,0,32,32],[128,0,32,32],[160,0,32,32],[192,0,32,32],[224,0,32,32]],Wt.offset=[[0,0,!0],[-8,0,!0],[-16,0,!0],[-8,-8,!0],[0,-16,!0],[0,-8,!0],[0,0,!0],[0,0,!0]];let Jt={tab:0,tab_select:!0,item_select:[0],select_length:1,role_select:!1,who_use:0,scroll:[0],system_select:0,CursorOldPos:{x:0,y:0},CursorNeedUpdate:!1,visible:!1,cursor_time:0,mode:"Default",config_num:{timer:-1,mode:-1}},Kt={item_select:0};class Qt{static register(t,e,s,i,a,n){this[t]=new Object,this[t].img=e,this[t].drawX=s,this[t].drawY=i,this[t].drawWidth=a,this[t].drawHeight=n,this[t][Symbol.iterator]=function*(){yield this.img,yield this.drawX,yield this.drawY,yield this.drawWidth,yield this.drawHeight},this[t].draw=(e,s,i=0,a=0,n=0,o=0)=>{ls(this[t].img,this[t].drawX+i,this[t].drawY+a,this[t].drawWidth+n,this[t].drawHeight+o,Math.round(e),Math.round(s))},this[t].draw=(e,s,{startX:i,startY:a,endX:n,endY:o}={})=>{ft.save(),Qt.drawEreaInit(e,s,i,a,n,o),ls(this[t].img,this[t].drawX,this[t].drawY,this[t].drawWidth,this[t].drawHeight,Math.round(e),Math.round(s)),ft.restore()}}static registerNineSlice(t,e,s,i,a){this[t]=new Object,this[t].img=e,this[t].nineSliceSize=s,this[t].baseSizeWidth=i,this[t].baseSizeHeight=a,this[t].draw=(e,i,a,n,{startX:o,startY:r,endX:h,endY:c}={})=>{ft.save(),Qt.drawEreaInit(e,i,{startX:o,startY:r,endX:h,endY:c});const l=new T(this[t].baseSizeWidth,this[t].baseSizeHeight),u=new C(e,i,a,n),d=[[0,0,s,s,u.x-s,u.y-s,s,s],[s,0,l.w,s,u.x,u.y-s,u.w,s],[s+l.w,0,s,s,u.x+u.w,u.y-s,s,s],[0,s,s,l.h,u.x-s,u.y,s,u.h],[s,s,l.w,l.h,u.x,u.y,u.w,u.h],[s+l.w,s,s,l.h,u.x+u.w,u.y,s,u.h],[0,s+l.h,s,s,u.x-s,u.y+u.h,s,s],[s,s+l.h,l.w,s,u.x,u.y+u.h,u.w,s],[s+l.w,s+l.h,s,s,u.x+u.w,u.y+u.h,s,s]];for(const e of d)ls(this[t].img,...e),ft.restore()}}static drawEreaInit(t,e,s,i,a,n){const o=t+s,r=e+i,h=a-s,c=n-i;Ve(s,i,a,n)&&(ft.beginPath(),ft.rect(o,r,h,c),ft.clip())}static init(){Qt.register("hp",Tt.gui,48,0,16,8),Qt.register("toggleOn",Tt.gui,0,16,16,8),Qt.register("toggleOff",Tt.gui,0,24,16,8),Qt.register("cursor",Tt.gui,32,0,8,8),Qt.register("cursorUns",Tt.gui,32,8,8,8),Qt.register("cursorBusy0",Tt.gui,40,0,8,8),Qt.register("cursorBusy1",Tt.gui,40,8,8,8),Qt.register("itemHealIcon",Tt.gui,224,0,32,0),Qt.registerNineSlice("prompt",Tt.gui_prompt,8,8,8)}}class Zt{constructor(t,e=0,s=0,i=void 0,a){if(!t in Mt.jsonui)throw t+" is not defined";let n=Mt.jsonui[t];this.type=t,this.state=1,this.openTime=0,this.closeTime=0,this.activeTime=0,this.inactiveTime=0,this.openDelay=n[0].openDelay??0,this.closeDelay=n[0].closeDelay??0,this.opened=!1,this.closed=!1,this.select=n[0].default_select??0,this.pos=new M(e,s),this.data=new Object,this.dataGroval=new Object,this.CanMovePlayer=n[0].CanMovePlayer??!1,this.UIGroup=Mt.jsonui[this.type];for(const t of Object.keys(n)){let e=n[t];if("list"===e.type)ct.UIListScrollable.includes(e.renderer)&&(this.data[e.id]={scroll:0,select:0}),"roles"===e.renderer&&(this.data[e.id].itemIndex=a)}}open(){return this.state=1,this.openTime=0,this.activeTime=0,!0}close(){return-1!==this.state&&(this.state=-1,this.closeTime=0,this.inactiveTime=0,!0)}GetSelectID(){return Mt.jsonui[this.type][this.select].id}get index(){return re.indexOf(this)}ShouldOpenAnim(){let t=re[re.length-1];return this.getUIContent(0)?.inactiveHidden?.this&&t.getUIContent(0)?.inactiveHidden?.target?1===this.state&&ae(this.index):1===this.state}ShouldCloseAnim(){let t=re[re.length-1];return!1===this.getUIContent(0)?.inactiveHidden?.this||!1===t.getUIContent(0)?.inactiveHidden?.target?-1===this.state:-1===this.state||!ae(this.index)}ActiveChangeDetect(){let t=re[re.length-1];this.#s=!t.getUIContent(0)?.inactiveHidden?.target,this.#s||(this.#i.active=!this.#i.TickAgo&&ae(this.index)&&void 0!==this.#i.TickAgo,this.#i.inactive=this.#i.TickAgo&&!ae(this.index)&&void 0!==this.#i.TickAgo,this.#i.TickAgo=ae(this.index),this.#i.active&&(this.activeTime=0),this.#i.inactive&&(this.inactiveTime=0))}#i={active:!1,inactive:!1,TickAgo:void 0};#s=!1;getUIContent(t){return this.UIGroup[t]}defaultProc(...t){for(let e of t)void 0!==e?.default&&(e=Object.assign(e,Mt.jsonui._default[e.default]),delete e.default)}closeCheck(){this.closed&&re.splice(this.index,1)}tick(){this.ActiveChangeDetect(this.index),1===this.state&&this.openTime++,-1===this.state&&this.closeTime++,this.ShouldOpenAnim(this.index)&&this.activeTime++,this.ShouldCloseAnim(this.index)&&this.inactiveTime++,this.openTime>=this.openDelay&&(this.opened=!0),this.closeTime>=this.closeDelay&&(this.closed=!0)}draw(){for(const t of this.UIGroup){this.defaultProc(t,...Array.toArray(t.animIn),...Array.toArray(t.animOut),t.trans);let e=new te(t,this,!1),s=re[this.index];switch("OffsetX"===t.drawLog&&(re[this.index].data[t.id]=e.Offset.x),t.type){case"text":ns(Ze(ne(t.text),void 0,t,void 0,this.index),e.Offset.x,e.Offset.y,{color:ct.colorPallet.black,align:"start",startX:0,startY:0,endX:e.size.x,endY:e.size.y});break;case"button":os(e.Offset.x,e.Offset.y,e.size.x,e.size.y,Tt.gui_prompt),ns(Ze(t.text),e.Offset.x,e.Offset.y,{color:ct.colorPallet.black,align:"start",startX:0,startY:0,endX:e.size.x,endY:e.size.y});break;case"tabConfig":new te(Mt.jsonui[UIID][0],this.index).Offset.x,e.Offset.x;case"tab":rs(e.Offset.x,e.Offset.y,e.size.x,e.size.y,Tt.gui_prompt,Tt.gui_tab_select,t.tabType,s.data.selectid===t.id),ns(Ze(t.text),e.Offset.x,e.Offset.y,{color:ct.colorPallet.black,align:"start",startX:0,startY:0,endX:e.size.x,endY:e.size.y});break;case"rectangle":os(e.Offset.x,e.Offset.y,e.size.x,e.size.y,Tt.gui_prompt);break;case"list":this.listRenderer(t,e)}}gt.uiActiveTime&&(ns(this.activeTime,0,16*this.index+0,{}),ns(this.inactiveTime,0,16*this.index+8,{}))}getListItems(t){switch(t){case"items":return U;case"roles":case"hud_hp":return B;case"UIOpen":return Object.keys(Mt.jsonui);case"config":return e=this.data.tab,S.filter((t=>t.group===e))}var e}listRenderer(t,e){let s=this.getListItems(t.renderer);switch(t.renderer){case"items":case"roles":case"hud_hp":case"UIOpen":case"config":let i=re[this.index].data[t.id].scroll;for(let a in s.slice(Math.floor(i/16),Math.floor(i/16)+Math.ceil(e.size.y/16+1))){let n=16*a-i%16,o=Number(a)+Math.floor(i/16),r=s[o];for(const s of Object.keys(t.items)){let i=new M(...t.items[s].offset),a=new M(...t.items[s].size),h=new Object;if(h.top=Math.min(n+i.y,0),h.bottom=Math.min(n+i.y+a.y,e.size.y)-n-i.y,-h.top>=a.y)continue;if(-h.bottom>0)continue;let c=(t,s=ct.colorPallet.black,a=0,o=0)=>{ns(t,i.x+e.Offset.x+a,i.y+e.Offset.y+o+n,{color:s,align:void 0,startX:0,startY:-n-i.y,endX:e.size.x-i.x-a,endY:e.size.y-i.y-o-n})},l=(t,s,a,o,r,h=0,c=0)=>{const l=i.x+e.Offset.x+h,u=i.y+e.Offset.y+c+n,d=-n-i.y;ls(t,s,a,o,r,l,u,{startX:e.size.x-i.x-h,startY:e.size.y-i.y-c-n,endX:0,endY:d})};switch(t.items[s].tag){case"atlas_img":ls(Tt.items,Te(r.id,0),Te(r.id,1)-h.top,a.x,h.bottom+h.top,Math.min(i.x,e.size.x)+e.Offset.x,Math.min(n,e.size.y)+e.Offset.y+i.y-h.top);break;case"text":c(Ze(t.items[s].text));break;case"ttftext":draw_text_ttf(Ze(t.items[s].text));break;case"ItemRender":l(Tt.items,Te(r.icon,0),Te(r.icon,1),16,16);break;case"ItemName":c(r.getDisplayName());break;case"ItemCount":c(r.count,ct.colorPallet.magenta);break;case"ItemEfficacy":c(r.getDisplayEfficacy,"start","black",32,0),l(...r.getDisplayEfficacyIcon());break;case"ConfigName":c(Ze(r.name));break;case"ConfigValue":if("bool"===r.type)r.value?l(Tt.gui,0,16,16,8):l(Tt.gui,0,24,16,8);else c(Ze(r.value));break;case"debugtest":c(`${h.top},${h.bottom}`,"_purple");break;case"role_icon":ls(Tt.gui,8*B[o].id,48-h.top,a.x,h.bottom+h.top,Math.min(i.x,e.size.x)+e.Offset.x,Math.min(n,e.size.y)+e.Offset.y+i.y-h.top);break;case"role_hp":c(B[o].health);break;case"img":case"image":Qt[t.items[s].img].draw(Math.min(i.x,e.size.x)+e.Offset.x,Math.min(n,e.size.y)+e.Offset.y+i.y-h.top,0,-h.top,0,h.bottom+h.top-a.y);break;case"uilist":c(r,"_purple")}}}}}control(){let t=this.getUIContent(this.select),e=t=>{for(const e of t)s(...e)},s=(e,...s)=>{for(let e in s)s[e]=ne(s[e],this.UIGroup,t,this,this.index);switch(e){case"select_abs":re[this.index].select=s[0];break;case"select_rel":re[this.index].select+=s[0];break;case"open":oe(...s);break;case"close":re[this.index].close();break;case"closeAll":re.forEach(((t,e)=>{e>=s[0]&&t.close()}));break;case"UseItem":if(!(s[0]in U))break;U[s[0]].mayUse(s[1]);break;case"data":re[this.index].data[s[0]]=s[1];break;case"ChangeConfig":let t=S[this.data.configRender.select];if("bool"===t.type)t.value=!t.value}};if(void 0!==t.trans){void 0!==t.trans.tickBefore&&e(t.trans.tickBefore);for(let s of Object.keys(Nt).filter((e=>e in t.trans)))Nt[s]&&e(t.trans[s]);void 0!==t.trans.tickAfter&&e(t.trans.tickAfter)}if("list"===t.type&&ct.UIListScrollable.includes(t?.renderer)){let e=this.data[t.id];Xt.down.hold&&e.select<U.length-1&&e.select++,Xt.up.hold&&e.select>0&&e.select--,(Xt.down.hold||Xt.up)&&ps("select","gui"),16*e.select-e.scroll<=0&&(e.scroll+=Math.floor((16*e.select-e.scroll)/2)),16*e.select-e.scroll+16>new M(...t.size).y&&(e.scroll+=Math.ceil((16*e.select-e.scroll+16-new M(...t.size).y)/2))}}cursorTick(){let t=this.getUIContent(this.select),e=new te(t,this,!0),s=re[this.index].data[t.id];if(this.index==function(){for(let t=re.length-1;t>=0;t--){if(1===re[t].state)return t}}()&&t.ShowCursor)if("list"===t.type)ct.UIListScrollable.includes(t.renderer)?he.push(new M(e.Offset.x+e.CursorOffset.x,e.Offset.y+e.CursorOffset.y+16*s.select-s.scroll)):he.push(new M(e.Offset.x+e.CursorOffset.x,e.Offset.y+e.CursorOffset.y));else he.push(new M(e.Offset.x+e.CursorOffset.x,e.Offset.y+e.CursorOffset.y))}}class te{constructor(t,e,s=!1){const i=new M(...t.offset),a=new M(...t.offset_type??[]);let n=i.x+ee(a.x,a.y).x+e.pos.x,o=i.y+ee(a.x,a.y).y+e.pos.y;if(this.Offset=new M(n,o),this.CursorOffset=new M(...t.CursorOffset??[-8,0]),this.size=new M(...t.size),s)return;const r=(t,e,s)=>{switch(t){case"easeOutExpo":return He(e)*s;case"easeInExpo":return(0===(i=e)?0:Math.pow(2,10*i-10))*s}var i},h=(t,e)=>{switch(t){case"offsetx":this.Offset.x+=Math.round(e);break;case"offsety":this.Offset.y+=Math.round(e);break;case"sizex":this.size.x+=Math.round(e);break;case"sizey":this.size.y+=Math.round(e)}};void 0!==t.animIn&&(e.ShouldOpenAnim(this.index,t)||e.opened)&&(new Array).concat(t.animIn).forEach((t=>{let s=-t.size+r(t.ease,(e.activeTime-t.offset)/t.length,t.size);h(t.type,s)})),void 0!==t.animOut&&(e.ShouldCloseAnim(this.index,t)||e.closed)&&(new Array).concat(t.animOut).forEach((t=>{let s=0+r(t.ease,(e.inactiveTime-t.offset)/t.length,t.size);h(t.type,s)}))}get index(){re.indexOf(this)}}function ee(t,e){let s,n;switch(t){case"left":default:s=0;break;case"right":s=i}switch(e){case"top":default:n=0;break;case"bottom":n=a}return new M(s,n)}function se(){for(let t in re){re[t].closed&&re.splice(t,1)}0!==re.length&&jsonui_select(re[re.length-1].type,re.length-1);let t=new Array;for(let e in re){let s=re[e];s.ActiveChangeDetect(e),1==s.state&&s.openTime++,-1==s.state&&s.closeTime++,s.ShouldOpenAnim(e,Mt.jsonui[s.type][0])&&s.activeTime++,s.ShouldCloseAnim(e)&&s.inactiveTime++,ie(s.type),jsonui_cursor(s.type,e,t),s.openTime>=s.openDelay&&(s.opened=!0),s.closeTime>=s.closeDelay&&(s.closed=!0)}he.draw()}function se(){for(let t of re)t.tick();for(let t of re)t.closeCheck();re[re.length-1].control()}function ie(){for(let t of re)t.draw();re[re.length-1].cursorTick(),he.draw()}function ae(t){return re.length-1==t}function ne(t,e,s,i,a){if("string"!=typeof t)return t;let n=t.split(","),o=n[0];for(let t of Object.keys(Mt.jsonui?.variable??{})){let e=Mt.jsonui.variable[t];if(o===t)return e}switch(o){case"$TabSelectID":return 0;case"$SelectID":return re[a].select;case"$UIContentID":return s.id;case"$selectUI":return Object.keys(Mt.jsonui)[i.select];case"$fps":return Pt;case"$getData":return i.data[n[1]];case"$getDataLocal":return i.data[s.id][n[1]];default:return o}}function oe(t,e,s,i,a){re.push(new Zt(t,e,s,i,a))}let re=new Array,he=new class{constructor(){this.CursorOldPos=new Object,this.CursorNeedUpdate=!1,this.CursorOldPos.x=0,this.CursorOldPos.y=0,this.cursors=new Array}draw(){let t=0;t+=5*He(l%100/100),t+=5*He(1-l%100/100),t-=8,ze()&&(t=0);let e="cursorBusy"+(l/8%8>=6?0:1);if(this.CursorNeedUpdate){let t=this.cursors[this.cursors.length-1];this.CursorNeedUpdate=!1,this.CursorOldPos.x=t.x,this.CursorOldPos.y=t.y}if(0!==this.cursors.length){let t=this.cursors[this.cursors.length-1];this.CursorOldPos.x+=(t.x-this.CursorOldPos.x)/2,this.CursorOldPos.y+=(t.y-this.CursorOldPos.y)/2,this.CursorOldPos.x=this.CursorOldPos.x.limit(0,1/0),this.CursorOldPos.y=this.CursorOldPos.y.limit(0,1/0)}for(let s in this.cursors){let i=this.cursors[s];s!=this.cursors.length-1&&Qt.cursorUns.draw(i.x,i.y),s==this.cursors.length-1&&Qt[ze()?e:"cursor"].draw(Math.round(this.CursorOldPos.x+t),this.CursorOldPos.y)}this.cursors=new Array}push(t){this.cursors.push(t)}};class ce{static main(){this.keyPress();for(const t of this.uiList)t.tick(),t.drawMain()}static keyPress(){const t=this.uiList.findLast((t=>!t.exited));for(const[e,s]of Object.entries(Xt))s.press&&t.keyPressed(e,"press"),s.down&&t.keyPressed(e,"down"),s.hold&&t.keyPressed(e,"hold")}static getUiof(t){return ce.uiList[t]}static uiList=new Array}class le{loop=!1;constructor(t,e,s,i,a,n){this.second=t,this.size=e,this.offset=s,this.delay=i,this.type=a,this.easing=n,this.now=Date.now()/1e3}get end(){return this.now+this.second}getProgress(){return(1-(this.end-Date.now()/1e3+this.delay)/this.second).limit(0,1)}getAnimationValue(){return(-1+this.easing(this.getProgress()))*this.size+this.offset}animatedPos(t){switch(this.type){case ue.posX:t.x+=this.getAnimationValue();break;case ue.posY:t.y+=this.getAnimationValue()}return t}static animatedPos(t,e){e=Array.toArray(e);for(const s of e)t=s.animatedPos(t);return t}}class ue{static register(t){ue[t]=Symbol(t)}}ue.register("posX"),ue.register("posY");class de{static none(t){return t}static easeOutElastic(t){const e=2*Math.PI/3;return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin((10*t-.75)*e)+1}static easeOutExpo(t){return 1===t?1:1-Math.pow(2,-10*t)}static easeInExpo(t){return 0===t?0:Math.pow(2,10*t-10)}}class me{exited=!1;static openUi(){return(new this).openUi()}openUi(){return ce.uiList.push(this)}drawMain(t=new I(0,0),e=new T(i,a),s={},n=[]){}drawChild(t,e,s=new I(0,0),n=new T(i,a),o={},r=[]){const[h=new I(0,0),c=new T(i,a),l={},u=[]]=t;e.drawMain(new I(h.x+s.x,h.y+s.y),n,o,r)}keyPressed(t,e){}tick(){this.exited&&this.exitCondition()&&this.exit()}exitCondition(){return!0}mayExitCondition(){return!0}exit(){ce.uiList.splice(this.getIndex(),1)}getIndex(){return ce.uiList.indexOf(this)}mayExit(){return!!this.mayExitCondition()&&(this.exited=!0,!0)}}class pe extends me{drawMain(t=new I(0,0),e=new T(i,a),s={},n=[]){t=le.animatedPos(t,n),Qt.prompt.draw(...t,...e,new A(0,0,0,0))}}class fe extends me{testButton=new pe;buttonAnim=new le(.1,10,null,0,ue.posY,de.easeInExpo);drawMain(t=new I(0,0),e=new T(i,a),s={},n=[]){this.drawChild(arguments,this.testButton,new I(8,8),new T(48,8),s,this.buttonAnim)}keyPressed(t,e){if("menu"===t)"down"===e&&(new ge).openUi()}}class ge extends me{menuTabParty=new pe;menuTabPartyAnim=new le(.1,64,0,0,ue.posX,de.easeOutExpo);menuTabItems=new pe;menuTabItemsAnim=new le(.1,64,0,.015,ue.posX,de.easeOutExpo);menuTabEquip=new pe;menuTabEquipAnim=new le(.1,64,0,.03,ue.posX,de.easeOutExpo);menuTabConfig=new pe;menuTabConfigAnim=new le(.1,64,0,.045,ue.posX,de.easeOutExpo);menuTabSave=new pe;menuTabSaveAnim=new le(.1,64,0,.06,ue.posX,de.easeOutExpo);selectTabIndex=0;tabs=[this.menuTabParty,this.menuTabItems,this.menuTabEquip,this.menuTabConfig,this.menuTabSave];drawMain(t=new I(0,0),e=new T(i,a),s={},n=[]){this.drawChild(arguments,this.menuTabParty,new I(16,16),new T(48,8),s,this.menuTabPartyAnim),this.drawChild(arguments,this.menuTabItems,new I(16,32),new T(48,8),s,this.menuTabItemsAnim),this.drawChild(arguments,this.menuTabEquip,new I(16,48),new T(48,8),s,this.menuTabEquipAnim),this.drawChild(arguments,this.menuTabConfig,new I(16,64),new T(48,8),s,this.menuTabConfigAnim),this.drawChild(arguments,this.menuTabSave,new I(16,80),new T(48,8),s,this.menuTabSaveAnim)}keyPressed(t,e){if("hold"===e)switch(t){case"up":this.selectTabIndexMoveTo(-1);break;case"down":this.selectTabIndexMoveTo(1);break;case"right":case"confirm":this.tabClick(this.selectTab)}"menu"!==t&&"left"!==t&&"cancel"!==t||"down"===e&&this.mayExit()}mayExit(){if(!this.mayExitCondition())return!1;super.mayExit(),this.menuTabPartyAnim=new le(.1,-64,-64,0,ue.posX,de.easeInExpo),this.menuTabItemsAnim=new le(.1,-64,-64,.015,ue.posX,de.easeInExpo),this.menuTabEquipAnim=new le(.1,-64,-64,.03,ue.posX,de.easeInExpo),this.menuTabConfigAnim=new le(.1,-64,-64,.045,ue.posX,de.easeInExpo),this.menuTabSaveAnim=new le(.1,-64,-64,.06,ue.posX,de.easeInExpo)}exitCondition(){return this.menuTabSaveAnim.getProgress()>=1}selectTabIndexMoveTo(t){const e=this.selectTabIndex;return this.selectTabIndex+=t.limit(0,this.tabs.length-1),e!==this.selectTabIndex}selectTabIndexTo(t){const e=this.selectTabIndex;return this.selectTabIndex=t.limit(0,this.tabs.length-1),e!==this.selectTabIndex}get selectTab(){return this.tabs[this.selectTabIndex]}tabClick(t){t===this.menuTabItems&&ye.openUi(),console.log(t)}}class ye extends me{}ct.lang=Mt.en_us;let we="en_us";function xe(){let t=Date.now(),n=!1;for(;t-c>.5*h;){be(),n=!0,c+=h;const e=Date.now();if(e-t>h*r){c<e-h&&(c=e-h);break}}n&&function(){_t++,kt=(new Date).getTime(),void(kt-vt>=1e3&&(Pt=_t,_t=0,vt=(new Date).getTime())),Me(!0),ft.clearRect(0,0,i,a),ct.PlayingScreen&&(R.tick(),us("layer1"),function(){for(const t of B)t.draw()}(),function(){for(const t of B)t.weapon.draw()}(),function(){for(let t of et)t.drawCondition()&&t.draw()}(),function(){for(const t of G)t.drawCondition()&&t.draw()}(),us("layer2"),ie(),ce.main(),ct.isRelease||function(){if(gt.visible){if(zt[75].press&&gt.camy++,zt[73].press&&gt.camy--,zt[76].press&&gt.camx++,zt[74].press&&gt.camx--,ft.strokeStyle=`rgb(\n        ${Ie([2*l%360,1,1])[0]},\n        ${Ie([2*l%360,1,1])[1]},\n        ${Ie([2*l%360,1,1])[2]}`,ft.strokeStyle="black",gt.hitbox_visible)for(const t in gt.hitboxes)ft.strokeStyle=gt.hitboxes[t].color,ft.strokeRect(gt.hitboxes[t].a-R.x,gt.hitboxes[t].b-R.y,gt.hitboxes[t].c,gt.hitboxes[t].d);gt.hitboxes.splice(0),as(gt.info,64,64),as([`FPS:${Pt}`,`m:${jt}ms`,`t:${l}`,`e:${G.length}`,`p:${et.length}`],0,136),as([`x:${F.pos.x}(${Math.floor(F.pos.x/16)})`,`y:${F.pos.y}(${Math.floor(F.pos.y/16)})`],64,0),ss("dc:"+gt.camx+","+gt.camy,0,24),Jt.visible&&(as(["itmsel:"+Jt.item_select,"scroll:"+Jt.scroll],128,0),3===Jt.tab&&0==Jt.item_select[0]&&(ss("timer:"+Jt.config_num.timer,128,128),ss("mode:"+Jt.config_num.mode,128,136)));{let t=["jsonuisel"];for(let e in re)t.push(`${re[e].select},${re[e].GetSelectID()}`);as(t,160,0)}as(["cursor",he.CursorOldPos.x,he.CursorOldPos.y],192,64);for(let t=0,e=0;t<zt.length;t++)zt[t],zt[t].press&&(ns(String.fromCharCode(t),312,8*e,{}),ns(`${t}`,296,8*e,{}),e++);{let t=0,e=0;for(const[s,i]of Object.entries(Xt))e=!1,i.press&&(ns(s.slice(0,2),272,8*t,{}),e||=!0),i.down&&(ns(s.slice(0,2),256,8*t,{}),e||=!0),i.hold&&(ns(s.slice(0,2),240,8*t,{}),e||=!0)}if(Yt.filter((t=>null===t)).length!==Yt.length)for(let t in Yt){let e=Yt[t];if(ss(`${t}`,288+-40*t,32),null!==e){for(let s=0,i=0;s<e.buttons.length;s++)e.buttons[s].pressed&&(ss(`${s}`,312+-40*t,8*i),i++);for(let s=0,i=0;s<e.axes.length;s++){let a=e.axes[s];ss(`${Ae(a,4,"")}`,288+-40*t,8*i),i++}}}!function(){for(let t in Rt)ss(""+t+Vt[t],Rt[t].x/e,Rt[t].y/s)}();for(const t of G){let e=G.indexOf(t);ss(t.health.toString(),t.pos.x-R.x,t.pos.y-R.y-16),ss(e.toString(),t.pos.x-R.x,t.pos.y-R.y-8)}for(const t of gt.pause_frame)l==t&&cancelAnimationFrame(u);ss("project2023\nbeta build\n"+ct.ver,232,152)}}());ct.PlayingScreen;Me(!1)}(),u=requestAnimationFrame(xe)}function be(){ct.lang=Object.assign(Mt.en_us,Mt[we]),function(){for(const t of zt)t.tick();for(const t of Object.values(Xt))t.tick()}(),Yt=navigator.getGamepads(),function(){if(!qt)return;for(const t in Gt){Ht[Gt[t].type]=!1;for(const e in Rt){let s=Rt[e].x,i=Rt[e].y,a=Gt[t].x,n=Gt[t].y,o=Gt[t].width,r=Gt[t].height;s>=a&&s<=a+o&&i>=n&&i<=n+r&&(Ht[Gt[t].type]=!0,Bt[Gt[t].type]=1==Vt[e],Ft[Gt[t].type]=Rt[e].timer==l-1)}}}(),ct.PlayingScreen&&function(){mt||(ct.map=Object.assign(Mt.Map,Mt.MapMeta));p=f+(new Date-y),ot.autoLoadDispose(R),function(){if(mt)return;F.tick();for(const t of B)t.tick();F.pos.x==F.movelog[0].x&&F.pos.y==F.movelog[0].y||F.movelog.unshift(new M(F.pos.x,F.pos.y))}(),function(){for(const t of G)t.tick()}(),function(){if(mt)return;for(const t of et)t.tick()}(),function(){if(ys(G,J).length>=50)return;for(let t=0;t<360;t+=3){let e=16;ts(Math.floor(F.pos.x/16+Math.cos(t)*e),Math.floor(F.pos.y/16+Math.sin(t)*e))}}(),se()}(),ct.PlayingScreen||(Xt.up.down&&Kt.item_select>0&&Kt.item_select--,Xt.down.down&&Kt.item_select<ct.title_items.length-1&&Kt.item_select++,(Xt.confirm.down||Xt.right.down)&&(0==Kt.item_select&&ct.NewGame(),1==Kt.item_select&&ct.LoadGame())),ct.sessionTime++}function ve(t){let e=pt.getBoundingClientRect(),s=(e.left,e.top,0);Ut.splice(0,1/0);for(const i of t.touches){let t={x:i.clientX-e.left,y:i.clientY-e.top,timer:l};Ut[s]=t,s++}qt=!0}document.addEventListener("readystatechange",(async function(){{let t=new Array;for(const e in x)t.push(Oe(_e,!At.fastLoad||x[e].nessesary,x[e].src,x[e].name));for(const e in b)t.push(Oe(Pe,!At.fastLoad||b[e].nessesary,b[e].src,b[e].name));for(const e in v)t.push(Oe(Se,!At.fastLoad||v[e].nessesary,v[e].src,v[e].name,v[e].meta));await Promise.all(t)}if(t)return;At.ejectLog&&console.log("game is starting");return async function(){const e=new URLSearchParams(window.location.search);null!=e.get("debug")&&(gt.visible=e.has("debug"));document.title="project 2023 "+ct.ver,X.init(),Qt.init(),W.init(),oe("hud"),S.beforeunload&&(w=setTimeout(Ee,1e4));t=!0}(),void(u=requestAnimationFrame(xe))})),function e(){(function(){ft.fillStyle="blue",ft.fillRect(0,0,i,a),ft.fillStyle="white",ft.strokeStyle="white",ns(`loading:${Math.floor(Ne()/$e()*100)}%\nImage: ${At.jsoncount}/${b.length}\nJson: ${At.imgcount}/${x.length}\nSound: ${At.soundcount}/${v.length}`,i/2,a/2,{color:ct.colorPallet.white,align:"center"});let t=new C((i-128)/2,a-16,128,8);ft.strokeRect(t.x,t.y,t.w,t.h),ft.fillRect(t.x+2,t.y+2,Ne()/$e()*(t.w-4),t.h-4)})(),t||(d=requestAnimationFrame(e))}();for(let t=0;t<Yt.length;t++){new Array;var ke=Yt[t];ke&&console.log(ke)}function Me(t){t&&(St=performance.now()),t||(Dt=performance.now()),t||(jt=Math.floor(Dt-St))}function Te(t,e){return 0==e?t%16*16:1==e?16*Math.floor(t/16):void 0}function Ce(t,e=t,s=!1){return s?Math.floor(Math.random()*(e-t)+t):Math.random()*(e-t)+t}function Ae(t="",e=5,s=void 0){return t=String(t),null!=s&&(e--,s=s[0]),t.length>e?t.slice(0,e)+String(s??""):t}function Ie(t){let e,s=t[0]/60,i=t[1],a=t[2];if(0==i)return[255*a,255*a,255*a];let n=parseInt(s),o=s-n,r=a*(1-i),h=a*(1-i*o),c=a*(1-i*(1-o));switch(n){case 0:case 6:e=[a,c,r];break;case 1:e=[h,a,r];break;case 2:e=[r,a,c];break;case 3:e=[r,h,a];break;case 4:e=[c,r,a];break;case 5:e=[a,r,h]}return e.map((function(t){return 255*t}))}Array.toArray=function(t){return(new Array).concat(t)};async function Oe(t,e,...s){e?await t(...s):t(...s)}async function Pe(t,e,s){try{let s=(new Date).getTime();const i=await fetch(t),a=await i.json();let n=(new Date).getTime();return null!=e&&(gt.jsonLoadTime[e]=n-s),document.getElementById("jsonLoadCount").innerText=String(++At.jsoncount),At.ejectLog&&console.log("loaded: "+t),null!=e&&(Mt[e]=a),a}catch{return null}}async function _e(t,e){Tt[e]=null;let s=new Promise((function(s){Tt[e]=new Image,Tt[e].onload=function(){document.getElementById("imgLoadCount").innerText=String(++At.imgcount),At.ejectLog&&console.log("loaded: "+t),s()},Tt[e].src=t}));return await s,Tt[e]}async function Se(t,e,s){return Ct[e]=await dt.init(t,s),document.getElementById("soundLoadCount").innerText=String(++At.soundcount),At.ejectLog&&console.log("loaded: "+t),Ct[e]}async function De(){let t;try{void 0===yt&&(yt=await window.showDirectoryPicker())}catch{return}const e=await yt.getFileHandle(It,{create:!0});t=await e.getFile(),xt=t;let s=await t.text();return JSON.parse(s)}async function je(t=!0){let e;if(e=t?await De():await async function(){try{wt=await window.showOpenFilePicker(Ot)}catch{return}Array.isArray(wt)&&(wt=wt[0]);let t=await wt.getFile(),e=await t.text();return JSON.parse(e)}(),null!=e)return f=e.playTime,g=e.playTime,player=e.player,B=e.players,enemy=e.enemy,S=e.config,bt=new Date(e.LastSavedTime),y=new Date,We(),Je(player.mapID,player.x,player.y,!1),xt}function Ee(){window.onbeforeunload=t=>{t.preventDefault(),t.returnValue="Check"}}function ze(){return ct.saveloadingnow||mt}function $e(){return x.length+b.length+v.length}function Ne(){return At.imgcount+At.jsoncount+At.soundcount}function Xe(t,e,s,i){return Math.abs(Math.sqrt(Math.pow(s-t,2)+Math.pow(i-e,2)))}function Le(t,e,s=10){return t.toString(s)[e]}function Ye(t){return t<1?Math.sin(6.28*t-2):t>=1?Math.sin(4.28):void 0}function Ue(t){return Math.log10(8*t*4)}function Re(t){return t<.5?Ue(t):t>=.5?1:void 0}function He(t){return 1===t?1:1-Math.pow(2,-10*t)}function Be(t,e,s,i){return ct.map[e][i][s]=t,t}function Fe(t,e,s){return ct.map.hitbox[s][e]=t,t}function Ve(...t){return null!=t&&t.every((t=>null!=t))}function Ge(t,e){let s=(t,e)=>ot.getTile(new I(t,e))?.hitbox??null;return!!s(Math.floor(t/16+0),Math.floor(e/16+0))||(!!s(Math.floor(t/16+.95),Math.floor(e/16+0))||(!!s(Math.floor(t/16+0),Math.floor(e/16+.95))||!!s(Math.floor(t/16+.95),Math.floor(e/16+.95))))}function qe(t,e,s,i,a,n,o,r,h="black"){es(t,e,s,i,h),es(a,n,o,r,h);let c=t+s/2,l=e+i/2,u=a+o/2,d=n+r/2,m=Math.abs(c-u),p=Math.abs(l-d);return m<(s+o)/2&&p<(i+r)/2}function We(){F.movelog.splice(0,1/0);for(let t=0;t<64;t++)F.movelog.push(new M(F.pos.x,F.pos.y))}async function Je(t,e,s,i=!1){mt=!0;{let e=new Array;e.push(Pe(ct.map_path[t],"Map")),e.push(Pe(ct.map_path[t]+"meta","MapMeta")),await Promise.all(e)}if(F.mapID=t,!i){G=new Array;for(let t of Mt.MapMeta.entity??[])new Z[t.id](t.x,t.y,t.dialogueID);void 0===e||void 0===s||isNaN(e)||isNaN(s)||([F.pos.x,F.pos.y]=[e,s]),(void 0===e||void 0===s||isNaN(e)||isNaN(s))&&([F.pos.x,F.pos.y]=[Mt.Map.player[0],Mt.Map.player[1]])}mt=!1}function Ke(t){return F.movelog[16*t].x}function Qe(t){return F.movelog[16*t].y}function Ze(t,...e){if("string"!=typeof ct.lang[t])return t;let s=ct.lang[t];for(let t in e)s=s.replace("%"+t,e[t]);return s}function Ze(t,...e){if(!((t=t.toString())in ct.lang))return t;let s,i=ct.lang[t];for(const[t,a]of e.entries()){const e=new RegExp(`\\{${t}\\}`,"g");s=i.replace(e,a)}return s}function ts(t,e){if(Ce(0,10)<9)return;let s=ot.getTile(new O(t,e));if(null==s||"number"!=typeof s)return!1;for(const s of G.filter((t=>t instanceof J)))if(s.spawn.x==16*t&&s.spawn.y==16*e)return!1;return!!Z.hasOwnProperty(s)&&(new Z[s](16*t,16*e),!0)}function es(t,e,s,i,a="black"){if(!gt.hitbox_visible)return;if(!gt.visible)return;let n={a:t,b:e,c:s,d:i,color:a};gt.hitboxes.push(n)}function ss(t,e,s,i=1/0,a=1/0,n="",o=-1,r=0,h=0,c=8,l=8){t=String(t),-1==o&&(e-=0*t.length),0==o&&(e-=4*t.length),1==o&&(e-=8*t.length);for(let o=0,u=0,d=0,m=0;u<t.length;o++)if("\n"==t.charAt(u)&&(m++,d=0),null!=t.charAt(u).match(/^(\n|\r|\t|\b|\f|\v|\0)$/)&&u++,u<=t.length&&is(t.charAt(u),e+8*d,s+8*m,n,r,h,c,l),u++,d++,i<d&&(m++,d=0),a<m)return"over height"}function ss(t,e,s){ns(t,e,s,{})}function is(t,e,s,i="",a=0,o=0,r=8,h=8){if(!n)return;t=String(t);let c=(l=t.charCodeAt(0).toString(16),u=4,(Array(u).join("0")+l).slice(-u));var l,u;let d=Tt.font["uni_"+Le(c,0,16)+Le(c,1,16)+i];null!=d&&ls(d,8*parseInt(Le(c,3,16),16)+a,8*parseInt(Le(c,2,16),16)+o,r,h,e,s)}function as(t,e,s){for(const i in t)ns(t[i],e,8*i+s,{})}function ns(t,e,s,{color:i=ct.colorPallet.black,align:a="start",startX:n,startY:r,endX:h,endY:c}){ft.save();const l=o,u=gs(l)?2:1,d=(gs(l),8);t=t.toString(),ft.font=`${8*u}px ${l}`,ft.fillStyle=i,ft.textAlign=a;const m=e+n,p=s+r,f=h-n,g=c-r;Ve(n,r,h,c)&&(ft.beginPath(),ft.rect(m,p,f,g),ft.clip()),t.split("\n").forEach(((t,i)=>{ft.fillText(t,e,s+i*d+8)})),ft.restore()}function os(t,e,s,i,a){ft.drawImage(a,0,0,8,8,t-8,e-8,8,8),ft.drawImage(a,8,0,8,8,t,e-8,s,8),ft.drawImage(a,16,0,8,8,t+s,e-8,8,8),ft.drawImage(a,0,8,8,8,t-8,e,8,i),ft.drawImage(a,16,8,8,8,t+s,e,8,i),ft.drawImage(a,0,16,8,8,t-8,e+i,8,8),ft.drawImage(a,8,16,8,8,t,e+i,s,8),ft.drawImage(a,16,16,8,8,t+s,e+i,8,8),ft.drawImage(a,8,8,8,8,t,e,s,i)}function rs(t,e,s,i,a,n,o,r){const h=-4,c={top:[[24,0],[16,0]],middle:[[16,8],[NaN,NaN]],bottom:[[24,16],[16,16]],topEdge:[[32,0],[8,0]],middleEdge:[[NaN,NaN],[NaN,NaN]],bottomEdge:[[32,16],[8,16]]},l=(t,e)=>new M(...c[e?t+"Edge":t][r?1:0]);ft.drawImage(a,0,0,8,8,t-8,e-8,8,8),ft.drawImage(a,8,0,8,8,t,e-8,s+h,8),ft.drawImage(n,0,0,8,8,t+s+h,e-8,8,8),ft.drawImage(n,l("top","top"===o).x,l("top","top"===o).y,8,8,t+s+h,e-8,8,8),ft.drawImage(a,0,8,8,8,t-8,e,8,i),ft.drawImage(n,0,8,8,8,t+s+h,e,8,i),ft.drawImage(a,l("middle",!1).x,l("middle",!1).y,8,8,t+s+h,e,8,i),ft.drawImage(a,0,16,8,8,t-8,e+i,8,8),ft.drawImage(a,8,16,8,8,t,e+i,s+h,8),ft.drawImage(n,0,16,8,8,t+s+h,e+i,8,8),ft.drawImage(n,l("bottom","bottom"===o).x,l("bottom","v"===o).y,8,8,t+s+h,e+i,8,8),ft.drawImage(a,8,8,8,8,t,e,s+h,i)}function hs(t){return t-R.x}function cs(t){return t-R.y}function ls(...t){let e=e=>void 0===t[e]?void 0:Math.floor(t[e]);ft.drawImage(t[0],e(1),e(2),e(3),e(4),e(5),e(6),e(7)??e(3),e(8)??e(4))}function us(t){let e=Math.floor(R.x/16),s=Math.floor(R.y/16);for(let i=0;i<13;i++)for(let a=0;a<21;a++){let n=ot.getTile(new O(a+e,i+s))?.[t];const o=t=>((t<0&&t%16==0?1:0)+t)%16+(t<0?16:0),r=new M(16*a-o(R.x),16*i-o(R.y)),h=new M(16,16);ct.DontDrawTile.includes(n)||ft.drawImage(Tt.tiles,Te(n,0),Te(n,1),...h,...r,...h)}}function ds(t,e,s){ft.drawImage(Tt.item_model,Wt.atlas[t][0],Wt.atlas[t][1],Wt.atlas[t][2],Wt.atlas[t][3],e+Wt.offset[t][0],s+Wt.offset[t][1],Wt.atlas[t][2],Wt.atlas[t][3])}function ms(){return 0===re.length||re[re.length-1].CanMovePlayer}function ps(t="select",e="other",s=!1){S[ct.soundGroupsConfig[e]]&&Ct[t].play(s)}function fs(t,e){if(!ct.characterCheck)return!0;var s="10px "+e;ft.font="10px sans-serif";var i=ft.measureText(t).width;ft.font=s;var a=ft.measureText(t).width;let n=-1!==window.navigator.userAgent.toLowerCase().indexOf("firefox");return!!(t.charCodeAt(0)>=256&&n)||a!==i}function gs(t){return!ct.characterCheck||fs("a",t)}function ys(t,e){return t.filter((t=>!!Ve(e)||t instanceof e))}Number.prototype.between=function(t,e){return this>=t&&this<=e},Number.prototype.limit=function(t,e){return Math.min(Math.max(t,this),e)};